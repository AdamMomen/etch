# Docker Compose for Etch - Self-hosted Video Conferencing
#
# One-click deployment with auto-configured credentials.
# Override LIVEKIT_API_KEY and LIVEKIT_API_SECRET for production.
#
# Required ports: 7880 (TCP), 7881 (TCP), 7882 (UDP)
#
# For Coolify: After deploying, configure domains in the UI:
# - app service: your main domain (e.g., etch.yourdomain.com)
# - livekit service: WebSocket domain (e.g., livekit.yourdomain.com)

services:
  # LiveKit Media Server
  livekit:
    image: livekit/livekit-server:latest
    ports:
      - "7880:7880"           # HTTP/WebSocket API
      - "7881:7881"           # ICE/TCP fallback for restrictive networks
      - "7882:7882/udp"       # ICE/UDP mux - all WebRTC UDP traffic
    environment:
      # API keys - override in Coolify or .env for production
      LIVEKIT_KEYS: "${LIVEKIT_API_KEY:-APIKeyEtchDefault123}: ${LIVEKIT_API_SECRET:-EtchSecretKey456DefaultValueForDev789}"
      # Config passed directly via environment variable
      LIVEKIT_CONFIG: |
        port: 7880
        bind_addresses:
          - "0.0.0.0"
        rtc:
          tcp_port: 7881
          udp_port: 7882
          use_external_ip: true
          use_ice_lite: true
        redis:
          address: redis:6379
        room:
          auto_create: true
          empty_timeout: 300
          max_participants: 50
        logging:
          level: info
          sample: false
        turn:
          enabled: true
          udp_port: 7882
        signal_relay:
          retry_timeout: 15s
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:7880/"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s

  # Redis for LiveKit (required for production)
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Etch Application
  app:
    image: ghcr.io/adammomen/etch:latest
    depends_on:
      livekit:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${APP_PORT:-3000}:3000"
    volumes:
      - app-data:/app/data
    environment:
      - NODE_ENV=production
      - APP_URL=${APP_URL:-http://localhost:3000}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///app/data/etch.db}
      # LiveKit connection - use public URL for browser, internal for server
      - LIVEKIT_WS_URL=${LIVEKIT_WS_URL:-ws://livekit:7880}
      - LIVEKIT_HTTP_URL=http://livekit:7880
      # Public LiveKit URL for browser clients (set in Coolify)
      - LIVEKIT_URL=${LIVEKIT_URL:-ws://localhost:7880}
      # API keys - must match LiveKit service
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-APIKeyEtchDefault123}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-EtchSecretKey456DefaultValueForDev789}
      # Redis
      - REDIS_URL=redis://redis:6379
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  redis-data:
    driver: local
  app-data:
    driver: local
