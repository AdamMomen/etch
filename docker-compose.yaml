# Docker Compose for Etch - Self-hosted Video Conferencing
#
# Zero manual configuration required for Coolify deployment!
#
# Coolify auto-generates:
#   SERVICE_PASSWORD_LIVEKITKEY    - LiveKit API key
#   SERVICE_PASSWORD_64_LIVEKITSECRET - LiveKit API secret (64 chars)
#   SERVICE_URL_APP, SERVICE_FQDN_LIVEKIT - Domain URLs
#
# LiveKit auto-detects public IP via STUN (use_external_ip: true)
#
# Required ports: 7880 (TCP), 7881 (TCP), 7882 (UDP)

services:
  # LiveKit Media Server
  livekit:
    image: livekit/livekit-server:latest
    ports:
      - "7880:7880"           # HTTP/WebSocket API
      - "7881:7881"           # ICE/TCP fallback for restrictive networks
      - "7882:7882/udp"       # ICE/UDP mux - all WebRTC UDP traffic
    environment:
      # API keys - auto-generated by Coolify
      LIVEKIT_KEYS: "${SERVICE_PASSWORD_LIVEKITKEY}: ${SERVICE_PASSWORD_64_LIVEKITSECRET}"
      # Config passed directly via environment variable
      LIVEKIT_CONFIG: |
        port: 7880
        bind_addresses:
          - "0.0.0.0"
        rtc:
          tcp_port: 7881
          udp_port: 7882
          use_external_ip: true
          use_ice_lite: true
        redis:
          address: redis:6379
        room:
          auto_create: true
          empty_timeout: 300
          max_participants: 50
        logging:
          level: info
          sample: false
        turn:
          enabled: false
        signal_relay:
          retry_timeout: 15s
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:7880/"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s

  # Redis for LiveKit (required for production)
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Etch Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      livekit:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${APP_PORT:-3000}:3000"
    volumes:
      - app-data:/app/data
    environment:
      # Use Coolify's SERVICE_URL_APP if available, fallback for local dev
      - APP_URL=${SERVICE_URL_APP:-http://localhost:3000}
      # Public LiveKit URL for browser clients - use Coolify's domain
      - LIVEKIT_URL=wss://${SERVICE_FQDN_LIVEKIT}
      # API keys - auto-generated by Coolify
      - LIVEKIT_API_KEY=${SERVICE_PASSWORD_LIVEKITKEY}
      - LIVEKIT_API_SECRET=${SERVICE_PASSWORD_64_LIVEKITSECRET}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  redis-data:
    driver: local
  app-data:
    driver: local
