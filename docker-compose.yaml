# Docker Compose for Etch - Self-hosted Video Conferencing
#
# One-click deployment with auto-configured credentials.
# Override LIVEKIT_API_KEY and LIVEKIT_API_SECRET for production.

services:
  # LiveKit Media Server
  livekit:
    image: livekit/livekit-server:latest
    ports:
      - "7880:7880"           # HTTP/WebSocket - REQUIRED for clients
      - "7881:7881"           # TCP fallback for restrictive networks
      - "7882:7882/udp"       # TURN/UDP
      - "50000-50100:50000-50100/udp"  # RTP/UDP media ports
    labels:
      - "coolify.port=7880"
    environment:
      # API keys - override in Coolify or .env for production
      LIVEKIT_KEYS: "${LIVEKIT_API_KEY:-APIKeyEtchDefault123}: ${LIVEKIT_API_SECRET:-EtchSecretKey456DefaultValueForDev789}"
      # Config passed directly via environment variable
      # NODE_IP: Set to host IP for local dev (127.0.0.1), leave empty for production (auto-detect)
      NODE_IP: "${NODE_IP:-}"
      LIVEKIT_CONFIG: |
        port: 7880
        bind_addresses:
          - "0.0.0.0"
        rtc:
          port_range_start: 50000
          port_range_end: 50100
          use_ice_lite: true
          tcp_port: 7881
        redis:
          address: redis:6379
        room:
          auto_create: true
          empty_timeout: 300
          max_participants: 50
        logging:
          level: info
          sample: false
        turn:
          enabled: true
          udp_port: 7882
        signal_relay:
          retry_timeout: 15s
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:7880/"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s

  # Redis for LiveKit (required for production)
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Etch Application
  app:
    image: ghcr.io/adammomen/etch:latest
    depends_on:
      livekit:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${APP_PORT:-3000}:3000"
    labels:
      - "coolify.port=3000"
    volumes:
      - app-data:/app/data
    environment:
      - NODE_ENV=production
      - APP_URL=${APP_URL:-http://localhost:3000}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///app/data/etch.db}
      # LiveKit connection (internal Docker network)
      - LIVEKIT_WS_URL=${LIVEKIT_WS_URL:-ws://livekit:7880}
      - LIVEKIT_HTTP_URL=http://livekit:7880
      # API keys - must match LiveKit service
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-APIKeyEtchDefault123}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-EtchSecretKey456DefaultValueForDev789}
      # Redis
      - REDIS_URL=redis://redis:6379
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  redis-data:
    driver: local
  app-data:
    driver: local
