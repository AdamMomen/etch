<?xml version="1.0" encoding="UTF-8"?>
<story-context version="1.0" story-id="2-6-integrate-livekit-room-connection">
  <metadata>
    <generated>2025-12-01</generated>
    <story-title>Integrate LiveKit Room Connection</story-title>
    <story-status>drafted</story-status>
    <epic>Epic 2: Basic Meeting Experience</epic>
  </metadata>

  <story-summary>
    <user-story>
      As a user, I want to connect to the meeting room via LiveKit,
      so that I can communicate with other participants in real-time.
    </user-story>
    <acceptance-criteria-count>7</acceptance-criteria-count>
    <task-count>9</task-count>
  </story-summary>

  <documentation>
    <architecture-decisions>
      <decision id="ADR-002" title="LiveKit DataTracks for Annotations">
        Use LiveKit DataTracks instead of separate WebSocket for annotation sync.
        Already have LiveKit for media transport. DataTracks encrypted by default.
        Reliable and unreliable modes available. No additional infrastructure needed.
      </decision>
      <decision id="ADR-004" title="Zustand over Redux">
        Use Zustand for state management. Minimal boilerplate, ~1KB bundle size.
        Simple subscription model (slice-based re-renders). Works outside React.
      </decision>
    </architecture-decisions>

    <tech-spec-excerpt section="AC-2.6">
      <content>
        LiveKit Room Connection:
        - Client connects to LiveKit using token from API
        - Connection status shown (Connected/Disconnected)
        - Participant events trigger UI updates
        - Join/leave toasts shown for other participants

        Key Events to Handle:
        - RoomEvent.Connected - Connection established
        - RoomEvent.Disconnected - Connection lost
        - RoomEvent.ParticipantConnected - Remote participant joined
        - RoomEvent.ParticipantDisconnected - Remote participant left
        - RoomEvent.ConnectionStateChanged - State changes (for UI indicator)
      </content>
    </tech-spec-excerpt>

    <integration-pattern title="LiveKit Client">
      <code-example language="typescript">
// Client: Connect to room
import { Room, RoomEvent, ConnectionState } from 'livekit-client';

const room = new Room();
await room.connect(livekitUrl, token);

// Listen for participant events
room.on(RoomEvent.ParticipantConnected, (participant) => {
  // Add participant to store
});

room.on(RoomEvent.ParticipantDisconnected, (participant) => {
  // Remove participant from store
});

room.on(RoomEvent.ConnectionStateChanged, (state) => {
  // Update connection status UI
});
      </code-example>
    </integration-pattern>

    <token-structure>
      <description>
        JWT token generated by server contains participant metadata:
        - sub: Participant ID (UUID)
        - name: Display name
        - metadata: JSON string with { role, color }
        - exp: 1 hour expiry
      </description>
    </token-structure>
  </documentation>

  <existing-code>
    <file path="packages/client/src/stores/roomStore.ts" purpose="Current room state store - needs extension">
      <interface name="RoomInfo">
        <property name="roomId" type="string" />
        <property name="token" type="string" />
        <property name="livekitUrl" type="string" />
      </interface>
      <interface name="RoomState">
        <property name="currentRoom" type="RoomInfo | null" />
        <action name="setCurrentRoom" params="room: RoomInfo | null" />
        <action name="clearRoom" />
      </interface>
      <note>
        Story 2.6 will extend this store with:
        - isConnecting, isConnected, error state fields
        - liveKitRoom reference (Room instance or null)
        - participants array with local and remote participants
        - Actions: setConnectionState, setLocalParticipant, addRemoteParticipant, removeRemoteParticipant
      </note>
    </file>

    <file path="packages/client/src/stores/settingsStore.ts" purpose="User preferences with persistence">
      <interface name="SettingsState">
        <property name="displayName" type="string" />
        <property name="apiBaseUrl" type="string" />
        <property name="sidebarCollapsed" type="boolean" />
      </interface>
      <implementation-note>Uses zustand persist middleware with localStorage key 'nameless-settings'</implementation-note>
    </file>

    <file path="packages/client/src/components/MeetingRoom/MeetingRoom.tsx" purpose="Main meeting room layout">
      <key-sections>
        <section name="Connection Status Indicator" line="96-102">
          Currently shows static green dot and "Connected" text.
          Story 2.6 replaces this with dynamic ConnectionState-driven indicator.
        </section>
        <section name="Participant List" line="50-58">
          Currently mock local participant only.
          Story 2.6 will use participants from roomStore (local + remote).
        </section>
        <section name="Imports" line="1-8">
          Uses: react-router-dom (useParams, useNavigate), sonner (toast),
          settingsStore, roomStore, Sidebar, MeetingControlsBar, cn utility.
        </section>
      </key-sections>
      <hooks-in-use>
        <hook name="useParams" />
        <hook name="useNavigate" />
        <hook name="useSettingsStore" />
        <hook name="useRoomStore" />
        <hook name="useState" description="Local mic/video state" />
        <hook name="useEffect" description="Keyboard shortcuts, responsive resize" />
      </hooks-in-use>
    </file>

    <file path="packages/client/src/components/MeetingRoom/Sidebar.tsx" purpose="Participant list sidebar">
      <interface name="Participant">
        <property name="id" type="string" />
        <property name="name" type="string" />
        <property name="role" type="'host' | 'sharer' | 'annotator' | 'viewer'" />
        <property name="color" type="string" />
        <property name="isLocal" type="boolean" />
      </interface>
      <props name="SidebarProps">
        <prop name="isCollapsed" type="boolean" />
        <prop name="participants" type="Participant[]" />
        <prop name="localParticipantId" type="string" />
        <prop name="onInviteClick" type="() => void" />
        <prop name="onToggle" type="() => void" />
      </props>
      <note>Ready to receive remote participants from roomStore</note>
    </file>

    <file path="packages/client/src/components/MeetingRoom/MeetingControlsBar.tsx" purpose="Bottom control bar">
      <props name="MeetingControlsBarProps">
        <prop name="isMuted" type="boolean" />
        <prop name="isVideoOff" type="boolean" />
        <prop name="onMicToggle" type="() => void" />
        <prop name="onVideoToggle" type="() => void" />
        <prop name="onScreenShare" type="() => void" />
        <prop name="onLeave" type="() => void" />
      </props>
    </file>
  </existing-code>

  <dependencies>
    <current-dependencies>
      <dependency name="zustand" version="^5.0.9" purpose="State management" />
      <dependency name="react-router-dom" version="^7.9.6" purpose="Routing" />
      <dependency name="sonner" version="^2.0.7" purpose="Toast notifications" />
      <dependency name="react" version="^19.2.0" />
      <dependency name="lucide-react" version="^0.555.0" purpose="Icons" />
    </current-dependencies>

    <new-dependencies-required>
      <dependency name="livekit-client" version="^2.x" purpose="LiveKit WebRTC client">
        <key-imports>
          <import>Room</import>
          <import>RoomEvent</import>
          <import>ConnectionState</import>
          <import>Participant</import>
          <import>RemoteParticipant</import>
          <import>LocalParticipant</import>
        </key-imports>
      </dependency>
      <dependency name="@livekit/components-react" version="^2.x" purpose="React hooks (optional)">
        <note>Can use direct SDK instead if preferred - evaluate during implementation</note>
      </dependency>
    </new-dependencies-required>
  </dependencies>

  <testing-context>
    <test-framework>Vitest 2.0.0 + React Testing Library</test-framework>
    <test-setup-file>packages/client/src/test/setup.ts</test-setup-file>

    <existing-test-patterns>
      <pattern name="Store Testing">
        Direct store state manipulation via store.setState() in beforeEach.
        Use store.getState() to verify state changes.
        Example from MeetingRoom.test.tsx lines 33-44.
      </pattern>
      <pattern name="Component Rendering">
        Use MemoryRouter for route testing.
        Use screen.getByRole(), getByText(), getByLabelText() for queries.
        Use userEvent for interactions.
      </pattern>
      <pattern name="Mocking Navigation">
        Mock useNavigate with vi.fn() in vi.mock('react-router-dom').
        Verify calls with expect(mockNavigate).toHaveBeenCalledWith('/').
      </pattern>
      <pattern name="Async Testing">
        Use waitFor() for async state changes.
        Use fireEvent for keyboard events.
      </pattern>
    </existing-test-patterns>

    <mock-requirements>
      <mock name="MockLiveKitRoom">
        <description>Simulates LiveKit Room for testing connection lifecycle</description>
        <methods>
          <method name="connect" returns="Promise&lt;void&gt;" />
          <method name="disconnect" />
          <method name="on" params="event: string, callback: Function" />
          <method name="off" params="event: string, callback: Function" />
          <method name="emit" params="event: string, ...args: any[]" description="Test helper to simulate events" />
        </methods>
        <properties>
          <property name="state" type="ConnectionState" />
          <property name="localParticipant" type="MockLocalParticipant" />
          <property name="remoteParticipants" type="Map&lt;string, MockRemoteParticipant&gt;" />
        </properties>
        <suggested-location>packages/client/src/test/mocks/MockLiveKitRoom.ts</suggested-location>
      </mock>
    </mock-requirements>

    <test-ideas>
      <test-group name="useLiveKit Hook">
        <test>connects to LiveKit when token and URL provided</test>
        <test>updates connection state on ConnectionStateChanged event</test>
        <test>disconnects and cleans up on unmount</test>
        <test>handles connection failure gracefully</test>
        <test>returns null room when no token provided</test>
      </test-group>
      <test-group name="roomStore Participant Management">
        <test>addRemoteParticipant adds participant to list</test>
        <test>removeRemoteParticipant removes participant by ID</test>
        <test>setLocalParticipant sets local participant</test>
        <test>setConnectionState updates connection status</test>
      </test-group>
      <test-group name="Participant Metadata Parsing">
        <test>parses valid metadata JSON correctly</test>
        <test>returns defaults for invalid JSON</test>
        <test>returns defaults for empty metadata</test>
        <test>extracts role and color from metadata</test>
      </test-group>
      <test-group name="Connection Status Indicator">
        <test>shows green dot and Connected when connected</test>
        <test>shows amber dot and Connecting when connecting</test>
        <test>shows red dot and Disconnected when disconnected</test>
        <test>shows retry button on connection failure</test>
      </test-group>
      <test-group name="Toast Notifications">
        <test>shows join toast when participant connects</test>
        <test>shows leave toast when participant disconnects</test>
      </test-group>
    </test-ideas>
  </testing-context>

  <implementation-guidance>
    <file-structure>
      <new-file path="packages/client/src/hooks/useLiveKit.ts">
        Custom hook for LiveKit room connection and event management
      </new-file>
      <new-file path="packages/client/src/hooks/useLiveKit.test.ts">
        Tests for useLiveKit hook
      </new-file>
      <new-file path="packages/client/src/utils/participantMetadata.ts">
        Utility for parsing participant metadata from LiveKit
      </new-file>
      <new-file path="packages/client/src/utils/participantMetadata.test.ts">
        Tests for metadata parsing
      </new-file>
      <new-file path="packages/client/src/test/mocks/MockLiveKitRoom.ts">
        Mock LiveKit Room class for testing
      </new-file>
      <modified-file path="packages/client/src/stores/roomStore.ts">
        Extend with connection state and participant management
      </modified-file>
      <modified-file path="packages/client/src/components/MeetingRoom/MeetingRoom.tsx">
        Integrate useLiveKit hook, update connection indicator
      </modified-file>
    </file-structure>

    <code-patterns>
      <pattern name="LiveKit Event Subscription">
        <code language="typescript">
useEffect(() => {
  if (!room) return;

  const handleParticipantConnected = (participant: RemoteParticipant) => {
    const metadata = parseParticipantMetadata(participant.metadata || '');
    addRemoteParticipant({
      id: participant.identity,
      name: participant.name || participant.identity,
      role: metadata.role,
      color: metadata.color,
      isLocal: false,
    });
    toast.info(`${participant.name} joined`);
  };

  room.on(RoomEvent.ParticipantConnected, handleParticipantConnected);

  return () => {
    room.off(RoomEvent.ParticipantConnected, handleParticipantConnected);
  };
}, [room, addRemoteParticipant]);
        </code>
      </pattern>

      <pattern name="Extended RoomStore Interface">
        <code language="typescript">
interface RoomState {
  // Existing
  currentRoom: RoomInfo | null;
  setCurrentRoom: (room: RoomInfo | null) => void;
  clearRoom: () => void;

  // New for Story 2.6
  isConnecting: boolean;
  isConnected: boolean;
  connectionError: string | null;
  localParticipant: Participant | null;
  remoteParticipants: Participant[];

  setConnectionState: (state: { isConnecting?: boolean; isConnected?: boolean; error?: string | null }) => void;
  setLocalParticipant: (participant: Participant | null) => void;
  addRemoteParticipant: (participant: Participant) => void;
  removeRemoteParticipant: (participantId: string) => void;
}
        </code>
      </pattern>

      <pattern name="Connection Status Component">
        <code language="typescript">
function ConnectionStatusIndicator({ isConnecting, isConnected, error }: ConnectionStatusProps) {
  if (isConnecting) {
    return (
      &lt;div className="flex items-center gap-2"&gt;
        &lt;div className="h-2 w-2 rounded-full bg-amber-500 animate-pulse" /&gt;
        &lt;span className="text-sm text-muted-foreground"&gt;Connecting...&lt;/span&gt;
      &lt;/div&gt;
    );
  }

  if (error || !isConnected) {
    return (
      &lt;div className="flex items-center gap-2"&gt;
        &lt;div className="h-2 w-2 rounded-full bg-red-500" aria-label="Disconnected" /&gt;
        &lt;span className="text-sm text-muted-foreground"&gt;Disconnected&lt;/span&gt;
        &lt;Button variant="ghost" size="sm" onClick={onRetry}&gt;Retry&lt;/Button&gt;
      &lt;/div&gt;
    );
  }

  return (
    &lt;div className="flex items-center gap-2"&gt;
      &lt;div className="h-2 w-2 rounded-full bg-green-500" aria-label="Connected" /&gt;
      &lt;span className="text-sm text-muted-foreground"&gt;Connected&lt;/span&gt;
    &lt;/div&gt;
  );
}
        </code>
      </pattern>
    </code-patterns>

    <acceptance-criteria-mapping>
      <ac id="AC-2.6.1" tasks="Task 1, Task 2, Task 5">
        LiveKit connection with token - install deps, create hook, connect on room entry
      </ac>
      <ac id="AC-2.6.2" tasks="Task 2, Task 3, Task 5, Task 7">
        Connection success indicator - hook returns state, store tracks state, indicator component
      </ac>
      <ac id="AC-2.6.3" tasks="Task 3, Task 6, Task 8">
        Remote participant display - store actions, event subscription, sidebar update
      </ac>
      <ac id="AC-2.6.4" tasks="Task 6">
        Participant join notification - ParticipantConnected event handler with toast
      </ac>
      <ac id="AC-2.6.5" tasks="Task 6">
        Participant leave notification - ParticipantDisconnected event handler with toast
      </ac>
      <ac id="AC-2.6.6" tasks="Task 2, Task 7">
        Connection failure handling - error state in hook, retry button in indicator
      </ac>
      <ac id="AC-2.6.7" tasks="Task 3, Task 4">
        Participant metadata extraction - utility function, store integration
      </ac>
    </acceptance-criteria-mapping>
  </implementation-guidance>

  <references>
    <reference type="story" path="docs/sprint-artifacts/2-6-integrate-livekit-room-connection.md" />
    <reference type="tech-spec" path="docs/sprint-artifacts/tech-spec-epic-2.md" section="AC-2.6" />
    <reference type="architecture" path="docs/architecture.md" section="Integration Points" />
    <reference type="previous-story" path="docs/sprint-artifacts/2-5-create-meeting-room-layout-shell.md" status="done" />
  </references>
</story-context>
